{% extends 'base.html' %}

{% block title %}Rules{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static',filename='css/fileinput.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static',filename='css/parameter.css') }}">
    <link rel="stylesheet" href="{{ url_for('static',filename='css/select2.min.css') }}" rel="stylesheet" />
    <script src="{{ url_for('static',filename='js/fileinput.min.js') }}" async></script>
    <script src="{{ url_for('static',filename='js/jquery.session.js') }}" async></script>
    <script src="{{ url_for('static',filename='js/select2.min.js') }}" ></script>

{% endblock %}

{% block main %}
    {% with messages = get_flashed_messages(with_categories=True) %}
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message[0] }} alert-dismissible" role="alert">
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <li>{{ message[1] }}</li>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    <div class="container-fluid">
        <div class="row">
            <!--left-->
            <form name="form1" action="/rules/" enctype='multipart/form-data' method="POST">
                <div class="col-md-2" id="leftCol">
                    <div class="form-group">
                        <label>Rule Name:</label>
                        <input type="text" class="form-control name" placeholder="rule name" name="name" id="name" >
                    </div>
                    <div class="form-group">
                        <label>Release:</label>
                        <input type="text" class="form-control release" placeholder="release" name="release" id="release">
                    </div>
                    <div class="form-group">
                        <label>Customer:</label>
                        <input type="text" class="form-control customer" placeholder="customer" name="customer" id="customer">
                    </div>
                    <div class="form-group">
                        <hr>
                    </div>
                    <div class="form-group left-pannel">
                        <label>Select Use Parameters:</label>
                        <select class="form-control paraid" name="paraid" id="paraid">
                            <option value=""></option>
                            {% for userparameter in userparameters %}
                                <option value="{{ userparameter.id }}">{{ userparameter.name+'@'+userparameter.release }}</option>
                            {% endfor %}
                        </select>
                        <script>$(".form-control").find("option[value='{{ paraid }}']").attr("selected",true)</script>
                    </div>
                    <div class="form-group">
                        <label>Select Rules:</label>
                        <select class="form-control selectrule" name="ruleid" id="ruleid">
                            <option value=""></option>
                            {% for userrule in userrules %}
                                <option value="{{ userrule.id }}">{{ userrule.rulename+'@'+userrule.release }}</option>
                            {% endfor %}
                        </select>
                        <script>$(".form-control").find("option[value='{{ ruleid }}']").attr("selected",true)</script>
                    </div>
                    <div class="form-group buttonpost">
                        <button class="btn btn-primary btn-block save" name="saverule" id="saverule"  type="button">Save</button>
                        <button class="btn btn-primary btn-block export" name="export" id="export"  type="button">Export</button>
                        <label>Import rule from file:</label>
                        <input id="input-b1" name="input-b1" type="file" class="file">
                    </div>
                </div><!--/left-->
                <!--right-->
                <div class="col-md-10 parameter" id="rightCol">
                    <ul>
                        <label class="con con1 ruletitle" contenteditable="true" placeholder="Enter rule title here..." style="font-size:24px;"></label>
                        <button type="button" class="btn btn-primary addSub input-sm2">Add Subrule</button>
                        <button type="button" class="btn btn-danger delSub input-sm2">Delete</button>
                        <button type="button" class="btn btn-success upSub input-sm2">Up</button>
                        <button type="button" class="btn btn-info downSub input-sm2">Down</button>
                        <li>
                            <span>
                                <select class="paraname input-sm2 col-lg-1">
                                </select>
                            </span>
                            <span>
                                <select class="condition input-sm2">
                                  <option>IN</option>
                                  <option>NOT IN</option>
                                </select>
                            </span>
                            <span>
                                <select class="field input-sm2 ">
                                    <script>
                                        var fieldss = ["Problem ID","Title","Description","Severity","Top Importance","State","Group in Charge","Build","Release","Feature","Author","Reported Date","Test Subphase","Author Group","R&D Priority","Care Contact Group","Care Contact Person","Customer","R&D Information","State Changed to Closed","State Changed to Correction not needed","Additional","Optional","Target Release","Fault ID","Correction State","Grep_TargetRelease","NoGrep_TargetRelease"];
                                        document.write("<optgroup label=\"Source\">");
                                        $(fieldss).each(function (index, obj) {
                                            document.write("<option>"+obj+"</option>\n");
                                        });
                                        document.write("</optgroup>");
                                        document.write("<optgroup label=\"Parameters\">");
                                        if ($.session.get('paradata')) {
                                            $.each(JSON.parse($.session.get('paradata')), function (name, value) {
                                                //$(this).siblings('.paraname').append("<option>"+name+"</option>");
                                                document.write("<option>"+name+"</option>\n");
                                            });
                                        }
                                        document.write("</optgroup>");
                                    </script>
                                </select>
                                <button id="addField" type="button" class="btn btn-primary btn-sm addField input-sm2">Add</button>
                                <button id="delField" type="button" class="btn btn-danger btn-sm delField input-sm2">Del</button>
                            </span>
                            <span class="spreturn">
                                <select class="return input-sm2">
                                  <option>Self Define</option>
                                  <option selected = "selected">As Parameter</option>
                                  <option>True</option>
                                  <option>False</option>
                                </select>
                            </span>
                            <span class="spbreak ">
                                <select class="break input-sm2">
                                  <option>NA</option>
                                  <option>Break</option>
                                  <option>Continue</option>
                                </select>
                            </span>
                            <span>
                                <button id="addPara" type="button" class="btn btn-primary btn-sm addPara input-sm2" >Add Para</button>
                                <button id="delPara" type="button" class="btn btn-danger btn-sm delPara input-sm2">Del Para</button>
                                <button id="up" type="button" class="btn btn-success btn-sm upPara input-sm2">Up</button>
                                <button id="down" type="button" class="btn btn-info btn-sm downPara input-sm2">Down</button>
                                <button id="addParasub" type="button" class="btn btn-primary btn-sm addParasub input-sm2">Add Subpara</button>
                            </span>
                        </li>
                    </ul>
                </div><!--/right-->
            </form>
        </div><!--/row-->
    </div><!--/container-->
    <script>
        var fields = ["Problem ID","Title","Description","Severity","Top Importance","State","Group in Charge","Build","Release","Feature","Author","Reported Date","Test Subphase","Author Group","R&D Priority","Care Contact Group","Care Contact Person","Customer","R&D Information","State Changed to Closed","State Changed to Correction not needed","Additional","Optional","Target Release","Fault ID","Correction State","Grep_TargetRelease","NoGrep_TargetRelease"];
        var fieldshtml = "<select class=\"field input-sm2 \">\n"+
                "<optgroup label=\"Source\">";
        $(fields).each(function (index, obj) {
            var tmps = "<option>"+obj+"</option>\n";
            fieldshtml = fieldshtml + tmps;
        });
        fieldshtml = fieldshtml + "</optgroup>\n"+
                "<optgroup label=\"Parameters\">";
        if ($.session.get('paradata')) {
            $.each(JSON.parse($.session.get('paradata')), function (name, value) {
                //$(this).siblings('.paraname').append("<option>"+name+"</option>");
                fieldshtml=fieldshtml+"<option>"+name+"</option>\n";
            });
        }
        fieldshtml = fieldshtml + "</optgroup>\n</select>\n";
        var substep = "<ul>\n" +
            "                        <label class=\"con ruletitle\" contenteditable=\"true\" placeholder=\"Enter rule title here...\" style=\"font-size:24px;\"></label>\n" +
            "                        <button type=\"button\" class=\"btn btn-primary addSub input-sm2\">Add Subrule</button>\n" +
            "                        <button type=\"button\" class=\"btn btn-danger delSub input-sm2\">Delete</button>\n" +
            "                        <button type=\"button\" class=\"btn btn-success upSub input-sm2\">Up</button>\n" +
            "                        <button type=\"button\" class=\"btn btn-info downSub input-sm2\">Down</button>\n" +
            "                        <li>\n" +
            "                            <span>\n" +
            "                                <select class=\"paraname input-sm2 col-lg-1\">\n" +
            "                                </select>\n" +
            "                            </span>\n" +
            "                            <span>\n" +
            "                                <select class=\"condition input-sm2\">\n" +
            "                                  <option>IN</option>\n" +
            "                                  <option>NOT IN</option>\n" +
            "                                </select>\n" +
            "                            </span>\n" +
            "                            <span>\n" +
                                            fieldshtml +
            "                                <button id=\"addField\" type=\"button\" class=\"btn btn-primary btn-sm addField input-sm2\">Add</button>\n" +
            "                                <button id=\"delField\" type=\"button\" class=\"btn btn-danger btn-sm delField input-sm2\">Del</button>\n" +
            "                            </span>\n" +
            "                            <span class=\"spreturn \">\n" +
            "                                <select class=\"return input-sm2\">\n" +
            "                                  <option>Self Define</option>\n" +
            "                                  <option selected = \"selected\">As Parameter</option>\n" +
            "                                  <option>True</option>\n" +
            "                                  <option>False</option>\n" +
            "                                </select>\n" +
            "                            </span>\n" +
                "<span class=\"spbreak\">\n" +
            "                                <select class=\"break input-sm2\">\n" +
            "                                  <option>NA</option>\n" +
            "                                  <option>Break</option>\n" +
            "                                  <option>Continue</option>\n" +
            "                                </select>\n" +
            "                            </span>"+
            "                            <span>\n" +
            "                                <button id=\"addPara\" type=\"button\" class=\"btn btn-primary btn-sm addPara input-sm2\">Add Para</button>\n" +
            "                                <button id=\"delPara\" type=\"button\" class=\"btn btn-danger btn-sm delPara input-sm2\">Del Para</button>\n" +
            "                                <button id=\"up\" type=\"button\" class=\"btn btn-success btn-sm upPara input-sm2\">Up</button>\n" +
            "                                <button id=\"down\" type=\"button\" class=\"btn btn-info btn-sm downPara input-sm2\">Down</button>\n" +
            "                                <button id=\"addParasub\" type=\"button\" class=\"btn btn-primary btn-sm addParasub input-sm2\">Add Subpara</button>\n" +
            "                            </span>\n" +
            "\n" +
            "                        </li>\n" +
            "                    </ul>";
        var para = "<li>\n" +
            "                            <span>\n" +
            "                                <select class=\"paraname input-sm2 col-lg-1\">\n" +
            "                                </select>\n" +
            "                            </span>\n" +
            "                            <span>\n" +
            "                                <select class=\"condition input-sm2\">\n" +
            "                                  <option>IN</option>\n" +
            "                                  <option>NOT IN</option>\n" +
            "                                </select>\n" +
            "                            </span>\n" +
            "                            <span>\n" + fieldshtml +
            "                                <button id=\"addField\" type=\"button\" class=\"btn btn-primary btn-sm addField input-sm2\">Add</button>\n" +
            "                                <button id=\"delField\" type=\"button\" class=\"btn btn-danger btn-sm delField input-sm2\">Del</button>\n" +
            "                            </span>\n" +
            "                            <span class=\"spreturn\">\n" +
            "                                <select class=\"return input-sm2\">\n" +
            "                                  <option>Self Define</option>\n" +
            "                                  <option selected = \"selected\">As Parameter</option>\n" +
            "                                  <option>True</option>\n" +
            "                                  <option>False</option>\n" +
            "                                </select>\n" +
            "                            </span>\n" +
                "<span class=\"spbreak\">\n" +
            "                                <select class=\"break input-sm2\">\n" +
            "                                  <option>NA</option>\n" +
            "                                  <option>Break</option>\n" +
            "                                  <option>Continue</option>\n" +
            "                                </select>\n" +
            "                            </span>"+
            "                            <span>\n" +
            "                                <button id=\"addPara\" type=\"button\" class=\"btn btn-primary btn-sm addPara input-sm2\">Add Para</button>\n" +
            "                                <button id=\"delPara\" type=\"button\" class=\"btn btn-danger btn-sm delPara input-sm2\">Del Para</button>\n" +
            "                                <button id=\"up\" type=\"button\" class=\"btn btn-success btn-sm upPara input-sm2\">Up</button>\n" +
            "                                <button id=\"down\" type=\"button\" class=\"btn btn-info btn-sm downPara input-sm2\">Down</button>\n" +
            "                                <button id=\"addParasub\" type=\"button\" class=\"btn btn-primary btn-sm addParasub input-sm2\">Add Subpara</button>\n" +
            "                            </span>\n" +
            "\n" +
            "                        </li>";
        var field = "<select class=\"field input-sm2 \">\n" +
            "                              <option>Field1</option>\n" +
            "                              <option>Field2</option>\n" +
            "                            </select>";
        var btnfield = "<button id=\"addField\" type=\"button\" class=\"btn btn-primary btn-sm addField\">Add Field</button>\n" +
            "                            <button id=\"delField\" type=\"button\" class=\"btn btn-danger btn-sm delField\">Del Field</button>";
        var parasub = "<ul>\n" +
            "                                <li>\n" +
            "                                    <span>\n" +
            "                                        <select class=\"subcondition input-sm2 \">\n" +
            "                                            <option>AND</option>\n" +
            "                                            <option>AND NOT</option>\n" +
            "                                        </select>\n" +
            "                                    </span>\n" +
            "                                    <span>\n" +
            "                                        <select class=\"subparaname input-sm2 col-lg-1\">\n" +
            "                                          <option>Parameters</option>\n" +
            "                                          <option>Category</option>\n" +
            "                                          <option>3</option>\n" +
            "                                          <option>4</option>\n" +
            "                                          <option>5</option>\n" +
            "                                        </select>\n" +
            "                                    </span>\n" +
            "                                    <span>\n" +
            "                                        <select class=\"expression input-sm2\">\n" +
            "                                          <option>=</option>\n" +
            "                                          <option>!=</option>\n" +
            "                                          <option>\\></option>\n" +
            "                                          <option>include</option>\n" +
            "                                          <option>exclude</option>\n" +
            "                                        </select>\n" +
            "                                    </span>\n" +
            "                                    <span>\n" +
            "                                    <input type=\"text\" class=\"parasubvalue input-sm2\" placeholder=\"input value\" name=\"parasubvalue\" >\n" +
            "                                    </span>\n" +
            "                                    <span>\n" +
            "                                        <button id=\"add\" type=\"button\" class=\"btn btn-primary btn-sm add input-sm2\">Add</button>\n" +
            "                                        <button id=\"del\" type=\"button\" class=\"btn btn-danger btn-sm del input-sm2\">Del</button>\n" +
            "                                    </span>\n" +
            "                                </li>\n" +
            "                            </ul>";
        var parasub2 = "<li>\n" +
            "                                    <span>\n" +
            "                                        <select class=\"subcondition input-sm2\">\n" +
            "                                            <option>AND</option>\n" +
            "                                            <option>AND NOT</option>\n" +
            "                                        </select>\n" +
            "                                    </span>\n" +
            "                                    <span>\n" +
            "                                        <select class=\"subparaname input-sm2 col-lg-1\">\n" +
            "                                          <option>Parameters</option>\n" +
            "                                          <option>Category</option>\n" +
            "                                          <option>3</option>\n" +
            "                                          <option>4</option>\n" +
            "                                          <option>5</option>\n" +
            "                                        </select>\n" +
            "                                    </span>\n" +
            "                                    <span>\n" +
            "                                        <select class=\"expression input-sm2\">\n" +
            "                                          <option>=</option>\n" +
            "                                          <option>!=</option>\n" +
            "                                          <option>\\></option>\n" +
            "                                          <option>include</option>\n" +
            "                                          <option>exclude</option>\n" +
            "                                        </select>\n" +
            "                                    </span>\n" +
            "                                    <span>\n" +
            "                                    <input type=\"text\" class=\"parasubvalue input-sm2 \" placeholder=\"input value\" name=\"parasubvalue\" >\n" +
            "                                    </span>\n" +
            "                                    <span>\n" +
            "                                        <button id=\"add\" type=\"button\" class=\"btn btn-primary btn-sm add input-sm2\">Add</button>\n" +
            "                                        <button id=\"del\" type=\"button\" class=\"btn btn-danger btn-sm del input-sm2\">Del</button>\n" +
            "                                    </span>\n" +
            "                                </li>";
        $(document).ready(function(){
            $('.paraname').empty();
            $.session.clear();
            $('.parameter').on('click','.delSub', function(){
                $(this).parent('ul').remove();
            });
            $(".parameter").on("click",".addSub",function(){
                if ($.session.get('paradata'))
                {
                    var addselect = "<optgroup label=\"Parameters\">";
                    $.each(JSON.parse($.session.get('paradata')),function(name,value) {
                        //$(this).siblings('.paraname').append("<option>"+name+"</option>");
                        addselect = addselect + "<option>"+name+"</option>";
                    });
                    addselect = addselect + "</optgroup>\n<optgroup label=\"Source\">";
                    $(fields).each(function (index, obj) {
                        addselect = addselect +  "<option>"+obj+"</option>\n";
                    });
                    addselect = addselect + "</optgroup>\n<optgroup label=\"Rule\">";
                    $('.ruletitle').each(function(k, v){
                        addselect = addselect + "<option>"+$(this).text()+"</option>";
                    });
                    addselect = addselect + "</optgroup>";
                    addselect = "<ul>\n" +
            "                        <label class=\"con ruletitle\" contenteditable=\"true\" placeholder=\"Enter rule title here...\" style=\"font-size:24px;\"></label>\n" +
            "                        <button type=\"button\" class=\"btn btn-primary addSub\">Add Subrule</button>\n" +
            "                        <button type=\"button\" class=\"btn btn-danger delSub\">Delete</button>\n" +
            "                        <button type=\"button\" class=\"btn btn-success upSub\">Up</button>\n" +
            "                        <button type=\"button\" class=\"btn btn-info downSub\">Down</button>\n" +
            "                        <li>\n" +
            "                            <span>\n" +
            "                                <select class=\"paraname input-sm2 col-lg-1 \">\n" + addselect +
            "                                </select>\n" +
            "                            </span>\n" +
            "                            <span>\n" +
            "                                <select class=\"condition input-sm2 \">\n" +
            "                                  <option>IN</option>\n" +
            "                                  <option>NOT IN</option>\n" +
            "                                </select>\n" +
            "                            </span>\n" +
            "                            <span>\n" + fieldshtml +
            "                                <button id=\"addField\" type=\"button\" class=\"btn btn-primary btn-sm addField\">Add</button>\n" +
            "                                <button id=\"delField\" type=\"button\" class=\"btn btn-danger btn-sm delField\">Del</button>\n" +
            "                            </span>\n" +
            "                            <span class=\"spreturn input-sm2\">\n" +
            "                                <select class=\"return \">\n" +
            "                                  <option>Self Define</option>\n" +
            "                                  <option selected = \"selected\">As Parameter</option>\n" +
            "                                  <option>True</option>\n" +
            "                                  <option>False</option>\n" +
            "                                </select>\n" +
            "                            </span>\n" +
                            "<span class=\"spbreak\">\n" +
                        "                                <select class=\"break input-sm2\">\n" +
                        "                                  <option>NA</option>\n" +
                        "                                  <option>Break</option>\n" +
                        "                                  <option>Continue</option>\n" +
                        "                                </select>\n" +
                        "                            </span>"+
            "                            <span>\n" +
            "                                <button id=\"addPara\" type=\"button\" class=\"btn btn-primary btn-sm addPara\">Add Para</button>\n" +
            "                                <button id=\"delPara\" type=\"button\" class=\"btn btn-danger btn-sm delPara\">Del Para</button>\n" +
            "                                <button id=\"up\" type=\"button\" class=\"btn btn-success btn-sm upPara\">Up</button>\n" +
            "                                <button id=\"down\" type=\"button\" class=\"btn btn-info btn-sm downPara\">Down</button>\n" +
            "                                <button id=\"addParasub\" type=\"button\" class=\"btn btn-primary btn-sm addParasub\">Add Subpara</button>\n" +
            "                            </span>\n" +
            "\n" +
            "                        </li>\n" +
            "                    </ul>";
                    $(addselect).insertAfter($(this).parents('ul').first());
                }
                else
                {
                    $(substep).insertAfter($(this).parents('ul').first());
                }

            });
            $(".parameter").on("click",".addPara",function(){

                if ($.session.get('paradata'))
                {
                    var addselect = "<optgroup label=\"Parameters\">";
                    $.each(JSON.parse($.session.get('paradata')),function(name,value) {
                        //$(this).siblings('.paraname').append("<option>"+name+"</option>");
                        addselect = addselect + "<option>"+name+"</option>";
                    });
                    addselect = addselect + "</optgroup>\n<optgroup label=\"Source\">";
                    $(fields).each(function (index, obj) {
                        addselect = addselect +  "<option>"+obj+"</option>\n";
                    });
                    addselect = addselect + "</optgroup>\n<optgroup label=\"Rule\">";
                    $('.ruletitle').each(function(k, v){
                        addselect = addselect + "<option>"+$(this).text()+"</option>";
                    });
                    addselect = addselect + "</optgroup>";
                    addselect = "<li>\n" +
            "                            <span>\n" +
            "                                <select class=\"paraname input-sm2 col-lg-1\">\n" +addselect+
            "                                </select>\n" +
            "                            </span>\n" +
            "                            <span>\n" +
            "                                <select class=\"condition input-sm2\">\n" +
            "                                  <option >IN</option>\n" +
            "                                  <option>NOT IN</option>\n" +
            "                                </select>\n" +
            "                            </span>\n" +
            "                            <span>\n" + fieldshtml +
            "                                <button id=\"addField\" type=\"button\" class=\"btn btn-primary btn-sm addField input-sm2\">Add</button>\n" +
            "                                <button id=\"delField\" type=\"button\" class=\"btn btn-danger btn-sm delField input-sm2\">Del</button>\n" +
            "                            </span>\n" +
            "                            <span class=\"spreturn\">\n" +
            "                                <select class=\"return input-sm2 \">\n" +
            "                                  <option>Self Define</option>\n" +
            "                                  <option selected = \"selected\">As Parameter</option>\n" +
            "                                  <option>True</option>\n" +
            "                                  <option>False</option>\n" +
            "                                </select>\n" +
            "                            </span>\n" +
                            "<span class=\"spbreak\">\n" +
                        "                                <select class=\"break input-sm2 \">\n" +
                        "                                  <option>NA</option>\n" +
                        "                                  <option>Break</option>\n" +
                        "                                  <option>Continue</option>\n" +
                        "                                </select>\n" +
                        "                            </span>"+
            "                            <span>\n" +
            "                                <button id=\"addPara\" type=\"button\" class=\"btn btn-primary btn-sm addPara input-sm2\">Add Para</button>\n" +
            "                                <button id=\"delPara\" type=\"button\" class=\"btn btn-danger btn-sm delPara input-sm2\">Del Para</button>\n" +
            "                                <button id=\"up\" type=\"button\" class=\"btn btn-success btn-sm upPara input-sm2\">Up</button>\n" +
            "                                <button id=\"down\" type=\"button\" class=\"btn btn-info btn-sm downPara input-sm2\">Down</button>\n" +
            "                                <button id=\"addParasub\" type=\"button\" class=\"btn btn-primary btn-sm addParasub input-sm2\">Add Subpara</button>\n" +
            "                            </span>\n" +
            "\n" +
            "                        </li>";
                    $(addselect).insertAfter($(this).parents('li').first());
                }
                else
                {
                    $(para).insertAfter($(this).parents('li').first());
                }
            });
            $('.parameter').on('click','.addField', function(){
                $(fieldshtml).insertBefore($(this));
            });
            $('.parameter').on('click','.delField', function(){
                $(this).prev().prev().remove();
            });
            $('.parameter').on('click','.delPara', function(){
                $(this).parents('li').remove();
            });
            $('.parameter').on('click','.upPara', function(){
                $(this).parents('li').insertBefore($(this).parents('li').prev());
            });
            $('.parameter').on('click','.downPara', function(){
                $(this).parents('li').insertAfter($(this).parents('li').next());
            });
            $('.parameter').on('click','.upSub', function(){
                $(this).parents('ul').insertBefore($(this).parents('ul').prev());
            });
            $('.parameter').on('click','.downSub', function(){
                $(this).parents('ul').insertAfter($(this).parents('ul').next());
            });
            $(".parameter").on("click",".addParasub",function(){
                if ($.session.get('paradata'))
                {
                    var addselect = "<optgroup label=\"Parameters\">";
                    $.each(JSON.parse($.session.get('paradata')),function(name,value) {
                        //$(this).siblings('.paraname').append("<option>"+name+"</option>");
                        addselect = addselect + "<option>"+name+"</option>";
                    });
                    addselect = addselect + "</optgroup>\n<optgroup label=\"Source\">";
                    $(fields).each(function (index, obj) {
                        addselect = addselect +  "<option>"+obj+"</option>\n";
                    });
                    addselect = addselect + "</optgroup>\n<optgroup label=\"Rule\">";
                    $('.ruletitle').each(function(k, v){
                        addselect = addselect + "<option>"+$(this).text()+"</option>";
                    });
                    addselect = addselect + "</optgroup>";
                    addselect = "<ul>\n" +
            "                                <li>\n" +
            "                                    <span>\n" +
            "                                        <select class=\"subcondition input-sm2 \">\n" +
            "                                            <option>AND</option>\n" +
            "                                            <option>AND NOT</option>\n" +
            "                                        </select>\n" +
            "                                    </span>\n" +
            "                                    <span>\n" +
            "                                        <select class=\"subparaname input-sm2 \">\n" + addselect +
            "                                        </select>\n" +
            "                                    </span>\n" +
            "                                    <span>\n" +
            "                                        <select class=\"expression input-sm2 \">\n" +
            "                                          <option>=</option>\n" +
            "                                          <option>!=</option>\n" +
            "                                          <option>\\></option>\n" +
            "                                          <option>include</option>\n" +
            "                                          <option>exclude</option>\n" +
            "                                        </select>\n" +
            "                                    </span>\n" +
            "                                    <span>\n" +
            "                                    <input type=\"text\" class=\"parasubvalue input-sm2 \" placeholder=\"input value\" name=\"parasubvalue\" >\n" +
            "                                    </span>\n" +
            "                                    <span>\n" +
            "                                        <button id=\"add\" type=\"button\" class=\"btn btn-primary btn-sm add input-sm2\">Add</button>\n" +
            "                                        <button id=\"del\" type=\"button\" class=\"btn btn-danger btn-sm del input-sm2\">Del</button>\n" +
            "                                    </span>\n" +
            "                                </li>\n" +
            "                            </ul>";
                    $(this).parents("li").append($(addselect));
                }
                else
                {
                    $(this).parents("li").append($(parasub));
                }
            });
            $(".parameter").on("click",".add",function(){
                if ($.session.get('paradata'))
                {
                    var addselect = "<optgroup label=\"Parameters\">";
                    $.each(JSON.parse($.session.get('paradata')),function(name,value) {
                        //$(this).siblings('.paraname').append("<option>"+name+"</option>");
                        addselect = addselect + "<option>"+name+"</option>";
                    });
                    addselect = addselect + "</optgroup>\n<optgroup label=\"Source\">";
                    $(fields).each(function (index, obj) {
                        addselect = addselect +  "<option>"+obj+"</option>\n";
                    });
                    addselect = addselect + "</optgroup>\n<optgroup label=\"Rule\">";
                    $('.ruletitle').each(function(k, v){
                        addselect = addselect + "<option>"+$(this).text()+"</option>";
                    });
                    addselect = addselect + "</optgroup>";
                    addselect = "<li>\n" +
            "                                    <span>\n" +
            "                                        <select class=\"subcondition input-sm2 \">\n" +
            "                                            <option>AND</option>\n" +
            "                                            <option>AND NOT</option>\n" +
            "                                        </select>\n" +
            "                                    </span>\n" +
            "                                    <span>\n" +
            "                                        <select class=\"subparaname input-sm2 \">\n" + addselect +
            "                                        </select>\n" +
            "                                    </span>\n" +
            "                                    <span>\n" +
            "                                        <select class=\"expression input-sm2 \">\n" +
            "                                          <option>=</option>\n" +
            "                                          <option>!=</option>\n" +
            "                                          <option>\\></option>\n" +
            "                                          <option>include</option>\n" +
            "                                          <option>exclude</option>\n" +
            "                                        </select>\n" +
            "                                    </span>\n" +
            "                                    <span>\n" +
            "                                    <input type=\"text\" class=\"parasubvalue input-sm2 \" placeholder=\"input value\" name=\"parasubvalue\" >\n" +
            "                                    </span>\n" +
            "                                    <span>\n" +
            "                                        <button id=\"add\" type=\"button\" class=\"btn btn-primary btn-sm add input-sm2\">Add</button>\n" +
            "                                        <button id=\"del\" type=\"button\" class=\"btn btn-danger btn-sm del input-sm2\">Del</button>\n" +
            "                                    </span>\n" +
            "                                </li>";
                    $(this).parents("ul").first().append($(addselect));
                }
                else
                {
                    $(this).parents("ul").first().append($(parasub2));
                }
            });
            $(".parameter").on("click",".del",function(){
                $(this).parents("li").first().remove()
            });
            $(".paraid").change(function(){

                var pid = $("select[name='paraid']").find("option:selected").val();
                if (pid!="")
                {
                    $.ajax({
                      type: "post",
                      url: '/querypara/',
                      data:{"pid":pid},
                      dataType: 'json',
                      success: function (data) {
                          var jsondata = JSON.parse(data["parameter"]);
                          $('.paraname').empty();
                          $('.field').empty();
                          $('.paraname').append("<optgroup label=\"Parameters\">");
                          $('.field').append("<optgroup label=\"Parameters\">");
                          $.each(jsondata,function(name,value) {
                              $('.paraname').append("<option>"+name+"</option>");
                              $('.field').append("<option>"+name+"</option>");
                          });
                          $('.paraname').append("</optgroup>");
                          $('.field').append("</optgroup>");
                          $('.paraname').append("<optgroup label=\"Source\">");
                          $('.field').append("<optgroup label=\"Source\">");
                          $.each(fields,function(i,item) {
                              $('.paraname').append("<option>"+item+"</option>");
                              $('.field').append("<option>"+item+"</option>");
                          });
                          $('.paraname').append("</optgroup>");
                          $('.field').append("</optgroup>");
                          $.session.set('paradata', data["parameter"]);
                      }
                    });
                }
            });

            $(".parameter").on("change",".return",function(){
                var selectreturnoption = $(this).find("option:selected").text();
                var input = "<input type=\"text\" class=\"selfdefine input-sm2\" placeholder=\"input you return value\" name=\"selfdefine\" style=\"width: 50px\">";
                if (selectreturnoption == "Self Define")
                {
                    $(input).insertAfter($(this));
                }
                else
                {
                    $(this).siblings(".selfdefine").remove();
                }
            });
            $(".buttonpost").on("click",".save",function(){
                var json = {};
                json['rulename'] = $(".name").val();
                json['release'] = $(".release").val();
                json['customer'] = $(".customer").val();
                json['rule'] = [];
                $("div.parameter").children("ul").each(function(i, val){
                    var rule = {};
                    var title = $(this).children("label").text()
                    rule['title'] = title;
                    rule['parameters'] = [];
                    $(this).children('li').each(function(j, value){
                        var parameter = {};
                        parameter['paraname'] = $(this).children().children('.paraname').find("option:selected").text();
                        parameter['condition'] = $(this).children().children('.condition').find("option:selected").text();
                        parameter['seachfield'] = [];
                        $(this).children().children('.field').each(function(){
                            parameter['seachfield'].push($(this).find("option:selected").text());
                        });
                        parameter['return'] = $(this).children().children('.return').find("option:selected").text();
                        parameter['break'] = $(this).children().children('.break').find("option:selected").text();
                        parameter['return value'] = $(this).children().children('.selfdefine').val();
                        parameter['subparameter'] = [];
                        $(this).children('ul').children('li').each(function(k, v){
                            var subparameter = {};
                            subparameter['subcondition'] = $(this).children().children('.subcondition').find("option:selected").text();
                            subparameter['subparaname'] = $(this).children().children('.subparaname').find("option:selected").text();
                            subparameter['expression'] = $(this).children().children('.expression').find("option:selected").text();
                            subparameter['parasubvalue'] = $(this).children().children('.parasubvalue').val();
                            parameter['subparameter'].push(subparameter);
                        });
                        rule['parameters'].push(parameter);
                    });
                    json['rule'][i] = rule;
                  });
                //var name = $(this).siblings("input#name").val();
                var name = $(".name").val();
                var release = $(".release").val();
                var customer = $(".customer").val();
                var postdata = {
                    "postdata":JSON.stringify(json),
                    "name":name,
                    "release":release,
                    "customer":customer,
                    "paraid": $("select[name='paraid']").find("option:selected").val()
                };

                if (name != $.session.get('rulename'))
                {
                    $.ajax({
                      type: "post",
                      url: '/rules/',
                      data:postdata,
                      dataType: 'json',
                      success: function (data) {
                          alert(data["message"])
                      }
                    });
                }
                else
                {
                    $.ajax({
                      type: "post",
                      url: '/rules/update/',
                      data:postdata,
                      dataType: 'json',
                      success: function (data) {
                          alert(data["message"])
                      }
                    });
                }

            });
            $(".buttonpost").on("click",".export",function(){
                var postdata = {
                    "parameter": $("select[name='paraid']").find("option:selected").val(),
                    "rule": $("select[name='ruleid']").find("option:selected").val()
                };

                $.ajax({
                  type: "post",
                  url: '/exportrule/',
                  data:postdata,
                  dataType: 'json',
                  success: function (data) {
                      var ts = data['timestamp'];
                      var href = "/download/"+ts;
                      $('.buttonpost').append("<a href="+href+">Click to download</a>");
                  }
                });
            });

            $(".selectrule").change(function(){
                var ruleid = $("select[name='ruleid']").find("option:selected").val();
                if (ruleid != "")
                {
                    $.ajax({
                      type: "post",
                      url: '/rules/ref/',
                      data:{"ruleid":ruleid},
                      dataType: 'json',
                      success: function (data) {
                          $(".name").val(data['name']);
                          $(".release").val(data['release']);
                          $(".customer").val(data['customer']);
                          var paraid = data['paraid'];
                          var paraoption = "";
                          $.session.set('rulename', data["name"]);
                          $.ajax({
                              type: "post",
                              url: '/querypara/',
                              data:{"pid":paraid},
                              dataType: 'json',
                              success: function (data2) {
                                  $(".paraid").val(paraid);
                                  var jsondata = JSON.parse(data2["parameter"]);
                                  paraoption = paraoption + "<optgroup label=\"Parameters\">\n";
                                  $.each(jsondata,function(name,value) {
                                      paraoption = paraoption+ "<option>" + name + "</option>\n";
                                  });
                                  paraoption = paraoption + "</optgroup>\n<optgroup label=\"Source\">\n";
                                  $(fields).each(function (index, obj) {
                                      paraoption = paraoption +  "<option>"+obj+"</option>\n";
                                  });
                                  paraoption = paraoption + "</optgroup>\n<optgroup label=\"Rules\">\n";
                                  $.session.set('paradata', data2["parameter"]);
                                  var fieldshtmlss = "<select class=\"field input-sm2 \">\n"+
                                            "<optgroup label=\"Source\">";
                                  $(fields).each(function (index, obj) {
                                      var tmps = "<option>"+obj+"</option>\n";
                                      fieldshtmlss = fieldshtmlss + tmps;
                                  });
                                  fieldshtmlss = fieldshtmlss + "</optgroup>\n"+
                                      "<optgroup label=\"Parameters\">";
                                  if ($.session.get('paradata')) {
                                      $.each(JSON.parse($.session.get('paradata')), function (name, value) {
                                          //$(this).siblings('.paraname').append("<option>"+name+"</option>");
                                          fieldshtmlss=fieldshtmlss+"<option>"+name+"</option>\n";
                                      });
                                  }
                                  fieldshtmlss = fieldshtmlss + "</optgroup>\n</select>\n";
                                  var jsondata = JSON.parse(data["rule"])
                                  $('.parameter').children().remove()
                                  var rulehtml = "";
                                  $.each(jsondata['rule'],function(i,rule) {
                                      var parameterhtml = "";
                                      var title = rule["title"];
                                      if (i>0)
                                      {
                                          additional_title = jsondata['rule'][i-1]['title'];
                                          paraoption = paraoption+ "<option>" + additional_title + "</option>\n";
                                      }
                                      paraoption = paraoption + "</optgroup>\n";
                                      $.each(rule['parameters'],function(j,parameter) {
                                          var subparahtml = "";
                                          var paraname = parameter['paraname'];
                                          var paracondition = parameter['condition'];
                                          var seachfield = parameter['seachfield'];
                                          var retrurn_methor = parameter['return'];
                                          var returnvalue = parameter['return value'];
                                          var breakvalue = parameter['break'];
                                          var return_html = "";
                                          var fieldhtml = "";
                                          $(seachfield).each(function (index, obj) {
                                              fieldhtmltmp = fieldshtmlss;
                                              fieldhtmltmp=fieldhtmltmp.replace("<option>"+obj+"</option>","<option selected = \"selected\">"+obj+"</option>");
                                              fieldhtml = fieldhtml + fieldhtmltmp;
                                          });

                                          fieldhtml = fieldhtml +
                    "                                <button id=\"addField\" type=\"button\" class=\"btn btn-primary btn-sm addField input-sm2\">Add</button>\n" +
                    "                                <button id=\"delField\" type=\"button\" class=\"btn btn-danger btn-sm delField input-sm2\">Del</button>\n";
                                          $.each(parameter['subparameter'],function(k,subparameter) {
                                              var subcondition = subparameter['subcondition'];
                                              var subparaname = subparameter['subparaname'];
                                              var expression = subparameter['expression'];
                                              var parasubvalue = subparameter['parasubvalue'];
                                              paraoption2 = paraoption.replace("<option>" + subparaname + "</option>\n","<option selected = \"selected\">" + subparaname + "</option>\n");
                                              htmltemp = "<li>\n" +
                    "                                    <span>\n" +
                    "                                        <select class=\"subcondition input-sm2 \">\n" +
                    "                                            <option>AND</option>\n" +
                    "                                            <option>AND NOT</option>\n" +
                    "                                        </select>\n" +
                    "                                    </span>\n" +
                    "                                    <span>\n" +
                    "                                        <select class=\"subparaname input-sm2 \">\n" + paraoption2 +
                    "                                        </select>\n" +
                    "                                    </span>\n" +
                    "                                    <span>\n" +
                    "                                        <select class=\"expression input-sm2 \">\n" +
                    "                                          <option>=</option>\n" +
                    "                                          <option>!=</option>\n" +
                    "                                          <option>\\></option>\n" +
                    "                                          <option>include</option>\n" +
                    "                                          <option>exclude</option>\n" +
                    "                                        </select>\n" +
                    "                                    </span>\n" +
                    "                                    <span>\n" +
                    "                                    <input type=\"text\" class=\"parasubvalue input-sm2 \" placeholder=\"input value\" name=\"parasubvalue\" value=\"\">\n" +
                    "                                    </span>\n" +
                    "                                    <span>\n" +
                    "                                        <button id=\"add\" type=\"button\" class=\"btn btn-primary btn-sm add input-sm2\">Add</button>\n" +
                    "                                        <button id=\"del\" type=\"button\" class=\"btn btn-danger btn-sm del input-sm2\">Del</button>\n" +
                    "                                    </span>\n" +
                    "                                </li>";

                                              htmltemp=htmltemp.replace("<option>"+subcondition+"</option>","<option selected = \"selected\">"+subcondition+"</option>");
                                              htmltemp=htmltemp.replace("<option>"+expression+"</option>","<option selected = \"selected\">"+expression+"</option>");
                                              htmltemp=htmltemp.replace("<input type=\"text\" class=\"parasubvalue input-sm2 \" placeholder=\"input value\" name=\"parasubvalue\" value=\"\">","<input type=\"text\" class=\"parasubvalue input-sm2\" placeholder=\"input value\" name=\"parasubvalue\" value=\""+parasubvalue+"\">\n");
                                              subparahtml = subparahtml + htmltemp;
                                          });
                                          subparahtml = "<ul>\n"+subparahtml+"\n</ul>";
                                          if (returnvalue)
                                          {
                                              return_html = "<input type=\"text\" class=\"selfdefine input-sm2 \" placeholder=\"input you return value\" name=\"selfdefine\" value = \""+returnvalue+"\" style=\"width: 50px\">";
                                          }
                                          parameterhtmltmp = "<li>\n" +
                    "                            <span>\n" +
                    "                                <select class=\"paraname input-sm2 col-lg-1\">\n" +paraoption +
                    "                                </select>\n" +
                    "                            </span>\n" +
                    "                            <span>\n" +
                    "                                <select class=\"condition input-sm2 \">\n" +
                    "                                  <option>IN</option>\n" +
                    "                                  <option>NOT IN</option>\n" +
                    "                                </select>\n" +
                    "                            </span>\n" +
                    "                            <span>\n" + fieldhtml +
                    "                            </span>\n" +
                    "                            <span class=\"spreturn\">\n" +
                    "                                <select class=\"return input-sm2 \">\n" +
                    "                                  <option>Self Define</option>\n" +
                    "                                  <option>As Parameter</option>\n" +
                    "                                  <option>True</option>\n" +
                    "                                  <option>False</option>\n" +
                    "                                </select>\n" + return_html +
                    "                            </span>\n" +
                                                  "<span class=\"spbreak\">\n" +
                                              "                                <select class=\"break input-sm2 \">\n" +
                                              "                                  <option>NA</option>\n" +
                                              "                                  <option>Break</option>\n" +
                                              "                                  <option>Continue</option>\n" +
                                              "                                </select>\n" +
                                              "                            </span>"+
                    "                            <span>\n" +
                    "                                <button id=\"addPara\" type=\"button\" class=\"btn btn-primary btn-sm addPara input-sm2 \">Add Para</button>\n" +
                    "                                <button id=\"delPara\" type=\"button\" class=\"btn btn-danger btn-sm delPara input-sm2 \">Del Para</button>\n" +
                    "                                <button id=\"up\" type=\"button\" class=\"btn btn-success btn-sm upPara input-sm2 \">Up</button>\n" +
                    "                                <button id=\"down\" type=\"button\" class=\"btn btn-info btn-sm downPara input-sm2 \">Down</button>\n" +
                    "                                <button id=\"addParasub\" type=\"button\" class=\"btn btn-primary btn-sm addParasub input-sm2 \">Add Subpara</button>\n" +
                    "                            </span>\n" +
                    "\n" +subparahtml + "\n" +
                                          "</li>";
                                          parameterhtmltmp=parameterhtmltmp.replace("<option>"+paraname+"</option>","<option selected = \"selected\">"+paraname+"</option>");
                                          parameterhtmltmp=parameterhtmltmp.replace("<option>"+paracondition+"</option>","<option selected = \"selected\">"+paracondition+"</option>");
                                          parameterhtmltmp=parameterhtmltmp.replace("<option>"+retrurn_methor+"</option>","<option selected = \"selected\">"+retrurn_methor+"</option>");
                                          parameterhtmltmp=parameterhtmltmp.replace("<option>"+breakvalue+"</option>","<option selected = \"selected\">"+breakvalue+"</option>");
                                          parameterhtml = parameterhtml + parameterhtmltmp;
                                      });
                                      rulehtml = rulehtml + "<ul>\n" +
                    "                        <label class=\"con ruletitle\" contenteditable=\"true\" placeholder=\"Enter rule title here...\" style=\"font-size:24px;\">"+ title +"</label>\n" +
                    "                        <button type=\"button\" class=\"btn btn-primary addSub input-sm2 \">Add Subrule</button>\n" +
                    "                        <button type=\"button\" class=\"btn btn-danger delSub input-sm2 \">Delete</button>\n" +
                    "                        <button type=\"button\" class=\"btn btn-success upSub input-sm2 \">Up</button>\n" +
                    "                        <button type=\"button\" class=\"btn btn-info downSub input-sm2 \">Down</button>\n" + parameterhtml +
                    "                    </ul>";


                                  });
                                  $('.parameter').append(rulehtml);
                              }
                          });


                      } // end success
                    });  //end ajax1
                }   //end if
            });  //end
        });
    </script>
{% endblock %}
